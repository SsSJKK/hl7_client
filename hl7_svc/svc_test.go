package hl7svc

import (
	"encoding/json"
	"fmt"
	"testing"

	"github.com/kardianos/hl7"
	"github.com/kardianos/hl7/h231"
)

var data = []byte{
	11, 77, 83, 72, 124, 94, 126, 92, 38, 124, 124, 124, 124, 124, 50, 48, 50, 52, 48, 54, 50, 53, 49, 48, 49, 57, 51, 54, 124, 124, 79, 82, 85, 94, 82, 48, 49, 124, 50, 52, 124, 80, 124, 50, 46, 51, 46, 49, 124, 124, 124, 124, 124, 124, 85, 78, 73, 67, 79, 68, 69, 13, 80, 73, 68, 124, 49, 124, 124, 94, 94, 94, 94, 77, 82, 13, 80, 86, 49, 124, 49, 13, 79, 66, 82, 124, 49, 124, 124, 52, 124, 48, 48, 48, 48, 49, 94, 65, 117, 116, 111, 109, 97, 116, 101, 100, 32, 67, 111, 117, 110, 116, 94, 57, 57, 77, 82, 67, 124, 124, 124, 50, 48, 50, 52, 48, 53, 50, 57, 49, 51, 51, 51, 50, 56, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 124, 72, 77, 124, 124, 124, 124, 124, 124, 124, 124, 49, 13, 79, 66, 88, 124, 49, 124, 73, 83, 124, 48, 56, 48, 48, 49, 94, 84, 97, 107, 101, 32, 77, 111, 100, 101, 94, 57, 57, 77, 82, 67, 124, 124, 79, 124, 124, 124, 124, 124, 124, 70, 13, 79, 66, 88, 124, 50, 124, 73, 83, 124, 48, 56, 48, 48, 50, 94, 66, 108, 111, 111, 100, 32, 77, 111, 100, 101, 94, 57, 57, 77, 82, 67, 124, 124, 87, 124, 124, 124, 124, 124, 124, 70, 13, 79, 66, 88, 124, 51, 124, 73, 83, 124, 48, 56, 48, 48, 51, 94, 84, 101, 115, 116, 32, 77, 111, 100, 101, 94, 57, 57, 77, 82, 67, 124, 124, 67, 66, 67, 43, 68, 73, 70, 70, 124, 124, 124, 124, 124, 124, 70, 13, 79, 66, 88, 124, 52, 124, 73, 83, 124, 48, 49, 48, 48, 50, 94, 82, 101, 102, 32, 71, 114, 111, 117, 112, 94, 57, 57, 77, 82, 67, 124, 124, 208, 158, 208, 177, 209, 137, 208, 176, 209, 143, 124, 124, 124, 124, 124, 124, 70, 13, 79, 66, 88, 124, 53, 124, 78, 77, 124, 54, 54, 57, 48, 45, 50, 94, 87, 66, 67, 94, 76, 78, 124, 124, 54, 46, 50, 55, 124, 49, 48, 42, 57, 47, 76, 124, 52, 46, 48, 48, 45, 49, 48, 46, 48, 48, 124, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 54, 124, 78, 77, 124, 55, 48, 52, 45, 55, 94, 66, 65, 83, 35, 94, 76, 78, 124, 124, 48, 46, 48, 50, 124, 49, 48, 42, 57, 47, 76, 124, 48, 46, 48, 48, 45, 48, 46, 49, 48, 124, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 55, 124, 78, 77, 124, 55, 48, 54, 45, 50, 94, 66, 65, 83, 37, 94, 76, 78, 124, 124, 48, 46, 51, 124, 37, 124, 48, 46, 48, 45, 49, 46, 48, 124, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 56, 124, 78, 77, 124, 55, 53, 49, 45, 56, 94, 78, 69, 85, 35, 94, 76, 78, 124, 124, 51, 46, 57, 52, 124, 49, 48, 42, 57, 47, 76, 124, 50, 46, 48, 48, 45, 55, 46, 48, 48, 124, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 57, 124, 78, 77, 124, 55, 55, 48, 45, 56, 94, 78, 69, 85, 37, 94, 76, 78, 124, 124, 54, 50, 46, 56, 124, 37, 124, 53, 48, 46, 48, 45, 55, 48, 46, 48, 124, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 49, 48, 124, 78, 77, 124, 55, 49, 49, 45, 50, 94, 69, 79, 83, 35, 94, 76, 78, 124, 124, 48, 46, 51, 57, 124, 49, 48, 42, 57, 47, 76, 124, 48, 46, 48, 50, 45, 48, 46, 53, 48, 124, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 49, 49, 124, 78, 77, 124, 55, 49, 51, 45, 56, 94, 69, 79, 83, 37, 94, 76, 78, 124, 124, 54, 46, 49, 124, 37, 124, 48, 46, 53, 45, 53, 46, 48, 124, 72, 126, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 49, 50, 124, 78, 77, 124, 55, 51, 49, 45, 48, 94, 76, 89, 77, 35, 94, 76, 78, 124, 124, 49, 46, 54, 49, 124, 49, 48, 42, 57, 47, 76, 124, 48, 46, 56, 48, 45, 52, 46, 48, 48, 124, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 49, 51, 124, 78, 77, 124, 55, 51, 54, 45, 57, 94, 76, 89, 77, 37, 94, 76, 78, 124, 124, 50, 53, 46, 55, 124, 37, 124, 50, 48, 46, 48, 45, 52, 48, 46, 48, 124, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 49, 52, 124, 78, 77, 124, 55, 52, 50, 45, 55, 94, 77, 79, 78, 35, 94, 76, 78, 124, 124, 48, 46, 51, 49, 124, 49, 48, 42, 57, 47, 76, 124, 48, 46, 49, 50, 45, 49, 46, 50, 48, 124, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 49, 53, 124, 78, 77, 124, 53, 57, 48, 53, 45, 53, 94, 77, 79, 78, 37, 94, 76, 78, 124, 124, 53, 46, 49, 124, 37, 124, 51, 46, 48, 45, 49, 50, 46, 48, 124, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 49, 54, 124, 78, 77, 124, 55, 56, 57, 45, 56, 94, 82, 66, 67, 94, 76, 78, 124, 124, 52, 46, 51, 53, 124, 49, 48, 42, 49, 50, 47, 76, 124, 51, 46, 53, 48, 45, 53, 46, 53, 48, 124, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 49, 55, 124, 78, 77, 124, 55, 49, 56, 45, 55, 94, 72, 71, 66, 94, 76, 78, 124, 124, 49, 50, 53, 124, 103, 47, 76, 124, 49, 49, 48, 45, 49, 54, 48, 124, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 49, 56, 124, 78, 77, 124, 55, 56, 55, 45, 50, 94, 77, 67, 86, 94, 76, 78, 124, 124, 56, 52, 46, 52, 124, 102, 76, 124, 56, 48, 46, 48, 45, 49, 48, 48, 46, 48, 124, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 49, 57, 124, 78, 77, 124, 55, 56, 53, 45, 54, 94, 77, 67, 72, 94, 76, 78, 124, 124, 50, 56, 46, 54, 124, 112, 103, 124, 50, 55, 46, 48, 45, 51, 52, 46, 48, 124, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 50, 48, 124, 78, 77, 124, 55, 56, 54, 45, 52, 94, 77, 67, 72, 67, 94, 76, 78, 124, 124, 51, 51, 57, 124, 103, 47, 76, 124, 51, 50, 48, 45, 51, 54, 48, 124, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 50, 49, 124, 78, 77, 124, 55, 56, 56, 45, 48, 94, 82, 68, 87, 45, 67, 86, 94, 76, 78, 124, 124, 49, 50, 46, 53, 124, 37, 124, 49, 49, 46, 48, 45, 49, 54, 46, 48, 124, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 50, 50, 124, 78, 77, 124, 50, 49, 48, 48, 48, 45, 53, 94, 82, 68, 87, 45, 83, 68, 94, 76, 78, 124, 124, 52, 49, 46, 55, 124, 102, 76, 124, 51, 53, 46, 48, 45, 53, 54, 46, 48, 124, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 50, 51, 124, 78, 77, 124, 52, 53, 52, 52, 45, 51, 94, 72, 67, 84, 94, 76, 78, 124, 124, 51, 54, 46, 56, 124, 37, 124, 51, 55, 46, 48, 45, 53, 52, 46, 48, 124, 76, 126, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 50, 52, 124, 78, 77, 124, 55, 55, 55, 45, 51, 94, 80, 76, 84, 94, 76, 78, 124, 124, 50, 53, 57, 124, 49, 48, 42, 57, 47, 76, 124, 49, 48, 48, 45, 51, 48, 48, 124, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 50, 53, 124, 78, 77, 124, 51, 50, 54, 50, 51, 45, 49, 94, 77, 80, 86, 94, 76, 78, 124, 124, 57, 46, 48, 124, 102, 76, 124, 55, 46, 48, 45, 49, 49, 46, 48, 124, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 50, 54, 124, 78, 77, 124, 51, 50, 50, 48, 55, 45, 51, 94, 80, 68, 87, 94, 76, 78, 124, 124, 49, 53, 46, 57, 124, 124, 57, 46, 48, 45, 49, 55, 46, 48, 124, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 50, 55, 124, 78, 77, 124, 49, 48, 48, 48, 50, 94, 80, 67, 84, 94, 57, 57, 77, 82, 67, 124, 124, 48, 46, 50, 51, 52, 124, 37, 124, 48, 46, 49, 48, 56, 45, 48, 46, 50, 56, 50, 124, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 50, 56, 124, 78, 77, 124, 49, 48, 48, 49, 51, 94, 80, 76, 67, 67, 94, 57, 57, 77, 82, 67, 124, 124, 53, 50, 124, 49, 48, 42, 57, 47, 76, 124, 51, 48, 45, 57, 48, 124, 65, 124, 124, 124, 70, 13, 79, 66, 88, 124, 50, 57, 124, 78, 77, 124, 49, 48, 48, 49, 52, 94, 80, 76, 67, 82, 94, 57, 57, 77, 82, 67, 124, 124, 50, 48, 46, 50, 124, 37, 124, 49, 49, 46, 48, 45, 52, 53, 46, 48, 124, 65, 124, 124, 124, 70, 13, 28, 13,
}
var sData = `MSH|^~\\&|||||20240626012143||ORU^R01|1|P|2.3.1||||||UNICODE
PID|1||^^^^MR
PV1|1
OBR|1||1|00001^Automated Count^99MRC|||20240620150648|||||||||||||||||HM||||||||1
OBX|1|IS|08001^Take Mode^99MRC||O||||||F
OBX|2|IS|08002^Blood Mode^99MRC||W||||||F
OBX|3|IS|08003^Test Mode^99MRC||CBC+DIFF||||||F
OBX|4|IS|01002^Ref Group^99MRC||Общая||||||F
OBX|5|NM|6690-2^WBC^LN||12.82|10*9/L|4.00-10.00|H~N|||F
OBX|6|NM|704-7^BAS#^LN||0.02|10*9/L|0.00-0.10|N|||F
OBX|7|NM|706-2^BAS%^LN||0.1|%|0.0-1.0|N|||F
OBX|8|NM|751-8^NEU#^LN||8.58|10*9/L|2.00-7.00|H~N|||F
OBX|9|NM|770-8^NEU%^LN||66.9|%|50.0-70.0|N|||F
OBX|10|NM|711-2^EOS#^LN||0.33|10*9/L|0.02-0.50|N|||F
OBX|11|NM|713-8^EOS%^LN||2.6|%|0.5-5.0|N|||F
OBX|12|NM|731-0^LYM#^LN||3.17|10*9/L|0.80-4.00|N|||F
OBX|13|NM|736-9^LYM%^LN||24.8|%|20.0-40.0|N|||F
OBX|14|NM|742-7^MON#^LN||0.72|10*9/L|0.12-1.20|N|||F
OBX|15|NM|5905-5^MON%^LN||5.6|%|3.0-12.0|N|||F
OBX|16|NM|789-8^RBC^LN||5.99|10*12/L|3.50-5.50|H~N|||F
OBX|17|NM|718-7^HGB^LN||114|g/L|110-160|N|||F
OBX|18|NM|787-2^MCV^LN||59.2|fL|80.0-100.0|L~N|||F
OBX|19|NM|785-6^MCH^LN||19.1|pg|27.0-34.0|L~N|||F
OBX|20|NM|786-4^MCHC^LN||322|g/L|320-360|N|||F
OBX|21|NM|788-0^RDW-CV^LN||14.8|%|11.0-16.0|N|||F
OBX|22|NM|21000-5^RDW-SD^LN||34.1|fL|35.0-56.0|L~N|||F
OBX|23|NM|4544-3^HCT^LN||35.5|%|37.0-54.0|L~N|||F
OBX|24|NM|777-3^PLT^LN||477|10*9/L|100-300|H~N|||F
OBX|25|NM|32623-1^MPV^LN||8.8|fL|7.0-11.0|N|||F
OBX|26|NM|32207-3^PDW^LN||15.6||9.0-17.0|N|||F
OBX|27|NM|10002^PCT^99MRC||0.421|%|0.108-0.282|H~N|||F
OBX|28|NM|10013^PLCC^99MRC||101|10*9/L|30-90|H~N|||F
OBX|29|NM|10014^PLCR^99MRC||21.2|%|11.0-45.0|N|||F
OBX|30|IS|12013^RBC Abnormal distribution^99MRC||T||||||F
OBX|31|IS|15199-3^Microcytes^LN||T||||||F
`

func TestH(t *testing.T) {
	hl7Decoder := hl7.NewDecoder(h231.Registry, nil)
	// fmt.Printf("data: %s\n", data) //
	// parceData, err := hl7Decoder.Decode(data)
	parceData, err := hl7Decoder.Decode([]byte(sData))
	// fmt.Printf("err: %+v\n", err)/
	jData, err := json.Marshal(parceData)
	if err != nil {
		t.Fatal(err)
	}
	// fmt.Printf("parceData: %+v\n", parceData)
	// fmt.Printf("parceData: %s\n", jData)
	ob := &Object{}
	err = json.Unmarshal(jData, ob)
	if err != nil {
		t.Fatal(err)
	}
	// fmt.Printf("ob: %+v\n", ob)
	// ob.PatientResult[0].OrderObservation[0].Observation[0].OBX
	for _, v := range ob.PatientResult {
		for _, v := range v.OrderObservation {
			for _, v := range v.Observation {
				// fmt.Printf("v.OBX: %+v\n", v.OBX)
				fmt.Printf("v.OBX.ObservationIdentifier.Text: %v -> ", v.OBX.ObservationIdentifier.Text)
				fmt.Printf("%v\n", v.OBX.ObservationValue[0])
			}
		}
	}
}
